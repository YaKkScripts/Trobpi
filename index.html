<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balling.com | Live Connect</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #00bcd4;
            --bg: #f0f4f8;
            --white: #ffffff;
            --text: #333;
            --online: #4caf50;
            --error: #ff5252;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        
        .container { max-width: 1200px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; padding: 10px; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }

        /* UI Elements */
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; margin-bottom: 10px; }
        .app-grid { display: grid; grid-template-columns: 320px 1fr; gap: 15px; flex: 1; height: 82vh; }
        
        .sidebar { display: flex; flex-direction: column; padding: 15px; overflow-y: auto; }
        .contact-item { padding: 12px; margin-bottom: 8px; border-radius: 12px; cursor: pointer; background: #fff; border: 1px solid #eee; position: relative; }
        .contact-item.active { background: var(--primary); color: white; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; background: #ccc; }
        .status-dot.online { background: var(--online); box-shadow: 0 0 5px var(--online); }

        .chat-view { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .message-list { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #f9f9f9; }
        .bubble { max-width: 70%; padding: 10px 15px; border-radius: 15px; font-size: 0.95rem; }
        .bubble.me { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .bubble.them { align-self: flex-start; background: #eee; border-bottom-left-radius: 2px; }

        .input-area { padding: 15px; display: flex; gap: 10px; background: white; border-top: 1px solid #eee; }
        input { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #ddd; outline: none; }
        .btn { padding: 10px 20px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-main { background: var(--primary); color: white; }
        
        /* Notifications */
        .mailbox-modal { position: fixed; top: 70px; right: 20px; width: 300px; z-index: 1000; padding: 15px; border: 1px solid #ddd; }
    </style>
</head>
<body>

    <div class="container">
        <header id="mainHeader" class="glass app-header hidden">
            <div>
                <h2 style="color: var(--primary)">Balling.com</h2>
                <small id="myOnlineStatus"><span class="status-dot online"></span> You are Online</small>
            </div>
            <div style="display:flex; gap:15px; align-items:center;">
                <div style="cursor:pointer; font-size: 1.4rem;" onclick="toggleMailbox()">ðŸ“¬ <span id="mailCount" class="hidden" style="background:red; color:white; border-radius:50%; padding:2px 6px; font-size:10px;">0</span></div>
                <button class="btn" onclick="signOut()">Logout</button>
            </div>
        </header>

        <div id="authView" class="fade-in">
            <div class="glass" style="max-width: 400px; margin: 15vh auto; padding: 40px; text-align: center;">
                <h1 style="color: var(--primary); margin-bottom: 10px;">Balling.com</h1>
                <p style="margin-bottom: 25px;">Global Real-time Connect</p>
                <input type="text" id="username" placeholder="Username" style="width:100%; margin-bottom:10px;">
                <input type="password" id="password" placeholder="Password" style="width:100%; margin-bottom:10px;">
                <button class="btn btn-main" style="width:100%;" onclick="handleAuth()">Sign In / Sign Up</button>
                <p id="authError" style="color:red; font-size:0.8rem; margin-top:10px;"></p>
            </div>
        </div>

        <div id="appView" class="hidden app-grid">
            <aside class="sidebar glass">
                <div style="margin-bottom:20px;">
                    <h3 id="myNameDisplay">User</h3>
                    <code id="myIdDisplay" style="font-size:0.7rem; color:#888;">ID</code>
                </div>
                <button class="btn btn-main" style="margin-bottom:15px;" onclick="addFriendPrompt()">+ Add New Friend</button>
                <div id="contactList"></div>
            </aside>

            <main class="chat-view glass">
                <div id="chatHeader" class="hidden" style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h3 id="activeChatName">Friend Name</h3>
                        <small id="activeChatStatus">Offline</small>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-main" onclick="startCall()">ðŸ“ž Call</button>
                        <button class="btn" style="background:#ff5252; color:white;" onclick="blockUser()">Block</button>
                    </div>
                </div>

                <div id="messageList" class="message-list">
                    <div style="text-align:center; margin-top:100px; color:#aaa;">Select a contact to start balling</div>
                </div>

                <div id="inputBar" class="input-area hidden">
                    <input type="text" id="msgInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter')sendLiveMsg()">
                    <button class="btn btn-main" onclick="sendLiveMsg()">Send</button>
                </div>
            </main>
        </div>
    </div>

    <div id="mailbox" class="glass mailbox-modal hidden">
        <h4>New Requests</h4>
        <div id="mailItems" style="margin-top:10px;"></div>
    </div>

    <script>
        // --- CONFIGURATION (Replace with your own Supabase details) ---
        const SUPABASE_URL = 'https://your-project.supabase.co';
        const SUPABASE_KEY = 'your-anon-key';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let userSession = null;
        let activeChatId = null;
        let contacts = {};

        // --- AUTHENTICATION ---
        async function handleAuth() {
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value.trim();
            if(!user || !pass) return;

            // Check if user exists
            let { data: existingUser } = await supabase.from('users').select('*').eq('username', user).single();

            if (existingUser) {
                if (existingUser.password === pass) {
                    loginSuccess(existingUser);
                } else {
                    document.getElementById('authError').innerText = "Wrong password!";
                }
            } else {
                // Create user
                const newId = Math.floor(100000 + Math.random() * 900000);
                const { data: newUser } = await supabase.from('users').insert([{ 
                    username: user, 
                    password: pass, 
                    balling_id: newId,
                    friends: [],
                    online: true 
                }]).select().single();
                loginSuccess(newUser);
            }
        }

        function loginSuccess(userData) {
            userSession = userData;
            localStorage.setItem('balling_user', JSON.stringify(userData));
            document.getElementById('authView').classList.add('hidden');
            document.getElementById('appView').classList.remove('hidden');
            document.getElementById('mainHeader').classList.remove('hidden');
            document.getElementById('myNameDisplay').innerText = userData.username;
            document.getElementById('myIdDisplay').innerText = "ID: " + userData.balling_id;
            
            initLiveSubscriptions();
            renderContacts();
            requestNotificationPermission();
        }

        // --- REAL-TIME MESSAGING ---
        async function sendLiveMsg() {
            const text = document.getElementById('msgInput').value;
            if(!text || !activeChatId) return;

            const { error } = await supabase.from('messages').insert([{
                sender_id: userSession.balling_id,
                receiver_id: activeChatId,
                content: text,
                sender_name: userSession.username
            }]);

            document.getElementById('msgInput').value = "";
        }

        function initLiveSubscriptions() {
            // Listen for new messages
            supabase.channel('custom-all-channel')
            .on('postgres_changes', { event: 'INSERT', table: 'messages' }, payload => {
                const msg = payload.new;
                if(msg.receiver_id === userSession.balling_id || msg.sender_id === userSession.balling_id) {
                    if(activeChatId && (msg.sender_id === activeChatId || msg.receiver_id === activeChatId)) {
                        appendMessage(msg);
                    } else if(msg.receiver_id === userSession.balling_id) {
                        showBrowserNotification(msg.sender_name, msg.content);
                        updateMailbox(msg);
                    }
                }
            }).subscribe();
        }

        function appendMessage(msg) {
            const container = document.getElementById('messageList');
            const isMe = msg.sender_id === userSession.balling_id;
            const div = document.createElement('div');
            div.className = `bubble ${isMe ? 'me' : 'them'}`;
            div.innerText = msg.content;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // --- NOTIFICATIONS ---
        function requestNotificationPermission() {
            if ("Notification" in window) {
                Notification.requestPermission();
            }
        }

        function showBrowserNotification(sender, text) {
            if (Notification.permission === "granted") {
                new Notification(`Balling: ${sender}`, { body: text });
            }
        }

        // --- CONTACTS & BLOCKS ---
        function addFriendPrompt() {
            const id = prompt("Enter Friend's Balling ID:");
            if(id) {
                activeChatId = parseInt(id);
                document.getElementById('chatHeader').classList.remove('hidden');
                document.getElementById('inputBar').classList.remove('hidden');
                document.getElementById('messageList').innerHTML = "";
                // Logic to update Supabase 'friends' array goes here
            }
        }

        async function signOut() {
            await supabase.from('users').update({ online: false }).eq('balling_id', userSession.balling_id);
            localStorage.clear();
            location.reload();
        }

        window.onbeforeunload = () => {
            if(userSession) supabase.from('users').update({ online: false }).eq('balling_id', userSession.balling_id);
        };

    </script>
</body>
</html>
