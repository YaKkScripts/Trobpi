<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Balling.com | Cloud Connect</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #00e5ff;
            --primary-dark: #00b8d4;
            --bg: #f8fdff;
            --white: #ffffff;
            --text: #263238;
            --gray: #90a4ae;
            --glass: rgba(255, 255, 255, 0.9);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }

        /* Mobile Optimized Layout */
        .container { height: 100vh; display: flex; flex-direction: column; max-width: 100%; }
        .app-grid { display: grid; grid-template-columns: 1fr; height: 100vh; transition: 0.3s; }
        
        @media (min-width: 768px) {
            .app-grid { grid-template-columns: 350px 1fr; }
            .sidebar { display: flex !important; }
        }

        .glass { background: var(--glass); backdrop-filter: blur(15px); border: 1px solid rgba(0,229,255,0.1); }
        
        /* Sidebar & Headers */
        .sidebar { flex-direction: column; border-right: 1px solid #e0f0f5; overflow: hidden; background: white; }
        .user-header { padding: 20px; border-bottom: 1px solid #eee; }
        .contact-list { flex: 1; overflow-y: auto; padding: 10px; }
        .contact-item { padding: 12px 15px; border-radius: 15px; margin-bottom: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; border: 1px solid transparent; transition: 0.1s; }
        .contact-item:active { scale: 0.98; }
        .contact-item.active { background: #e0f7fa; border-color: var(--primary); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; }
        .status-online { background: #4caf50; box-shadow: 0 0 8px #4caf50; }

        /* Chat Area */
        .main-view { display: flex; flex-direction: column; background: #fff; height: 100%; position: relative; }
        .chat-header { padding: 12px 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; background: white; z-index: 10; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; background: #fcfdfe; }
        
        .bubble { max-width: 85%; padding: 10px 16px; border-radius: 20px; font-size: 15px; position: relative; animation: pop 0.2s ease-out; }
        @keyframes pop { from { opacity: 0; scale: 0.9; } to { opacity: 1; scale: 1; } }
        
        .bubble.me { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .bubble.them { align-self: flex-start; background: #f1f5f9; border-bottom-left-radius: 4px; }
        .bubble small { font-size: 10px; display: block; margin-top: 4px; opacity: 0.7; }

        /* Optimized Inputs */
        .input-bar { padding: 12px; display: flex; gap: 8px; align-items: center; background: white; border-top: 1px solid #eee; }
        input { padding: 12px 18px; border-radius: 25px; border: 1px solid #e0e0e0; outline: none; font-size: 16px; }
        .btn { padding: 10px 18px; border-radius: 25px; border: none; cursor: pointer; font-weight: 600; }
        .btn-primary { background: var(--primary); color: white; }

        /* Video Call Layout (Face on Left/Right) */
        .call-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; }
        .video-grid { flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; background: #111; }
        video { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

    <div id="authView">
        <div class="auth-card glass" style="width: 90%; max-width: 380px; padding: 30px; border-radius: 30px; margin: 100px auto; text-align: center;">
            <h1 style="color: var(--primary);">Balling.com</h1>
            <p id="authDesc" style="color: var(--gray); margin-bottom: 20px;">Fast Cloud Sync Enabled</p>
            <input type="text" id="usernameField" placeholder="Username" style="width:100%; margin-bottom:10px;">
            <input type="password" id="passwordField" placeholder="Password" style="width:100%; margin-bottom:10px;">
            <div id="idResult" class="hidden" style="background: #e0f7fa; padding: 10px; border-radius: 15px; margin-bottom: 10px;">
                <small>New ID Generated:</small><br><strong id="newId"></strong>
            </div>
            <button class="btn btn-primary" id="authBtn" style="width:100%" onclick="handleAuth()">Create Account</button>
            <a href="javascript:void(0)" onclick="toggleMode()" style="display:block; margin-top:15px; font-size:14px; color:var(--gray)">Switch Mode</a>
        </div>
    </div>

    <div id="appView" class="container hidden">
        <div class="app-grid">
            <aside class="sidebar" id="sidebar">
                <div class="user-header">
                    <h2 id="displayMyName">User</h2>
                    <small id="displayMyId" style="color:var(--gray)"></small>
                    <div style="margin-top:10px; display:flex; gap:5px;">
                        <button class="btn btn-primary" style="flex:1" onclick="showView('contacts')">Chats</button>
                        <button class="btn" style="flex:1; background:#eee" onclick="showView('groups')">Groups</button>
                        <button class="btn" style="background:#eee" onclick="showView('add')">+</button>
                    </div>
                </div>
                <div class="contact-list" id="contactContainer"></div>
                <div id="syncIndicator" style="font-size:10px; text-align:center; padding:5px; color:var(--gray)">SYNCING...</div>
            </aside>

            <main class="main-view">
                <div id="chatRoom" class="hidden" style="height:100%; display:flex; flex-direction:column;">
                    <div class="chat-header">
                        <span onclick="backToSidebar()" style="cursor:pointer">‚Üê <b id="activeChatName">Friend</b></span>
                        <button class="btn btn-primary" onclick="initiateCall()">üìû Call</button>
                    </div>
                    <div class="chat-messages" id="messageList"></div>
                    <div id="typingStatus" style="font-size:12px; padding:5px 20px; color:var(--gray); height:20px;"></div>
                    <div class="input-bar">
                        <button class="btn" onclick="toggleEmojis()" style="padding:5px">üòä</button>
                        <input type="text" id="chatInput" placeholder="Message..." style="flex:1" oninput="reportTyping()" onkeypress="if(event.key==='Enter')sendMessage()">
                        <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                    </div>
                    <div id="emojiDrawer" class="emoji-drawer hidden"></div>
                </div>

                <div id="addView" class="hidden" style="padding:20px;">
                    <h3>Add Contact</h3>
                    <input type="text" id="searchId" placeholder="(000) 000-000" style="width:100%; margin-top:10px;">
                    <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="searchAndAdd()">Add Friend</button>
                </div>

                <div id="groupView" class="hidden" style="padding:20px;">
                    <h3>Create Group</h3>
                    <input type="text" id="groupName" placeholder="Group Name" style="width:100%; margin-top:10px;">
                    <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="createGroup()">Create</button>
                </div>
            </main>
        </div>
    </div>

    <div id="callOverlay" class="hidden call-overlay">
        <div class="video-grid">
            <video id="localVideo" autoplay playsinline muted></video>
            <video id="remoteVideo" autoplay playsinline></video>
        </div>
        <div style="position:absolute; bottom:30px; width:100%; display:flex; justify-content:center; gap:20px;">
            <button class="btn" id="toggleMic" onclick="toggleMic()" style="background:#fff">üé§</button>
            <button class="btn" id="toggleCam" onclick="toggleCam()" style="background:#fff">üì∑</button>
            <button class="btn" onclick="endCall()" style="background:#ff5252; color:#fff">End</button>
        </div>
    </div>

    <script>
        const SB_URL = "https://ubpsifoqjfzgmvhvwspv.supabase.co";
        const SB_KEY = "sb_publishable_tW5cED71cJC5tZtXla5D-g_wv4NfVwo";
        const supabase = supabase.createClient(SB_URL, SB_KEY);

        let db = JSON.parse(localStorage.getItem('balling_cache')) || { users: {}, chats: {}, presence: {} };
        let currentUser = JSON.parse(localStorage.getItem('balling_session'));
        let activeId = null;
        let isLogin = false;
        let localStream;
        let lastSync = 0;

        // --- FAST LOAD LOGIC ---
        async function syncData() {
            // Only fetch if 2 seconds passed to keep it fast
            if (Date.now() - lastSync < 2000) return;
            
            const { data, error } = await supabase.from('balling_data').select('content').eq('id', 'main_db').single();
            if(data) {
                db = data.content;
                localStorage.setItem('balling_cache', JSON.stringify(db)); // Cache for instant loading next time
                renderContacts();
                if(activeId) renderMessages();
                checkPresence();
                checkIncomingCall();
                lastSync = Date.now();
                document.getElementById('syncIndicator').innerText = "CLOUD SYNCED";
            }
        }

        // --- OPTIMIZED SAVE (Throttled) ---
        let saveTimeout;
        function queueSave() {
            document.getElementById('syncIndicator').innerText = "UPDATING...";
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                await supabase.from('balling_data').upsert({ id: 'main_db', content: db });
                document.getElementById('syncIndicator').innerText = "CLOUD SYNCED";
            }, 500); // Wait 0.5s after typing stops to save
        }

        async function handleAuth() {
            const user = document.getElementById('usernameField').value.trim();
            const pass = document.getElementById('passwordField').value.trim();
            if(!user || !pass) return alert("Missing info");

            await syncData();

            if(isLogin) {
                const id = Object.keys(db.users).find(k => db.users[k].user === user && db.users[k].pass === pass);
                if(id) login(id);
                else alert("Wrong password");
            } else {
                const id = `(${Math.floor(Math.random()*800)+100}) ${Math.floor(Math.random()*800)+100}-${Math.floor(Math.random()*800)+100}`;
                db.users[id] = { user, pass, friends: {}, groups: [] };
                document.getElementById('newId').innerText = id;
                document.getElementById('idResult').classList.remove('hidden');
                document.getElementById('authBtn').innerText = "Login Now";
                document.getElementById('authBtn').onclick = () => login(id);
                queueSave();
            }
        }

        function login(id) {
            currentUser = { id, name: db.users[id].user };
            localStorage.setItem('balling_session', JSON.stringify(currentUser));
            location.reload(); 
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if(!text || !activeId) return;

            const room = activeId.includes('::') ? activeId : [currentUser.id, activeId].sort().join('::');
            if(!db.chats[room]) db.chats[room] = [];
            
            db.chats[room].push({ s: currentUser.id, n: currentUser.name, t: text, d: Date.now() });
            input.value = "";
            renderMessages();
            queueSave();
        }

        function renderMessages() {
            const room = activeId.includes('::') ? activeId : [currentUser.id, activeId].sort().join('::');
            const list = document.getElementById('messageList');
            const msgs = db.chats[room] || [];
            
            list.innerHTML = msgs.map(m => `
                <div class="bubble ${m.s === currentUser.id ? 'me' : 'them'}">
                    <small style="font-weight:bold">${m.n}</small>
                    ${m.t}
                </div>
            `).join('');
            list.scrollTop = list.scrollHeight;
        }

        function createGroup() {
            const name = document.getElementById('groupName').value.trim();
            const gId = "GROUP_" + Math.random().toString(36).substr(2, 9);
            db.users[currentUser.id].friends[gId] = "üë• " + name;
            db.chats[gId] = [{ s: 'system', n: 'Balling', t: `Group ${name} created`, d: Date.now() }];
            queueSave();
            showView('contacts');
        }

        function checkIncomingCall() {
            const me = db.presence[currentUser.id];
            if(me && me.callFrom && !localStream) {
                if(confirm("Incoming Call from " + me.callerName)) {
                    activeId = me.callFrom;
                    initiateCall();
                }
                delete db.presence[currentUser.id].callFrom;
                queueSave();
            }
        }

        async function initiateCall() {
            document.getElementById('callOverlay').classList.remove('hidden');
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('localVideo').srcObject = localStream;
            
            if(!activeId.includes('GROUP')) {
                db.presence[activeId] = { callFrom: currentUser.id, callerName: currentUser.name };
                queueSave();
            }
        }

        function endCall() {
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            localStream = null;
            document.getElementById('callOverlay').classList.add('hidden');
        }

        // --- UI HELPERS ---
        function toggleMode() { isLogin = !isLogin; document.getElementById('authBtn').innerText = isLogin ? "Login" : "Create Account"; }
        function backToSidebar() { document.getElementById('sidebar').style.display = 'flex'; document.getElementById('chatRoom').classList.add('hidden'); }
        function showView(v) {
            document.getElementById('chatRoom').classList.add('hidden');
            document.getElementById('addView').classList.toggle('hidden', v !== 'add');
            document.getElementById('groupView').classList.toggle('hidden', v !== 'groups');
        }

        function openChat(id) {
            activeId = id;
            document.getElementById('chatRoom').classList.remove('hidden');
            document.getElementById('addView').classList.add('hidden');
            document.getElementById('groupView').classList.add('hidden');
            document.getElementById('activeChatName').innerText = db.users[currentUser.id].friends[id];
            if(window.innerWidth < 768) document.getElementById('sidebar').style.display = 'none';
            renderMessages();
        }

        function renderContacts() {
            const container = document.getElementById('contactContainer');
            const friends = db.users[currentUser.id]?.friends || {};
            container.innerHTML = Object.keys(friends).map(fId => `
                <div class="contact-item ${activeId === fId ? 'active' : ''}" onclick="openChat('${fId}')">
                    <div class="status-dot ${ (Date.now() - (db.presence[fId]?.lastSeen || 0) < 10000) ? 'status-online' : ''}"></div>
                    <div><strong>${friends[fId]}</strong><br><small>${fId}</small></div>
                </div>
            `).join('');
        }

        function reportTyping() {
            db.presence[currentUser.id] = { typingTo: activeId, lastSeen: Date.now() };
            queueSave();
        }

        function checkPresence() {
            const status = document.getElementById('typingStatus');
            if(!activeId) return;
            const friend = db.presence[activeId];
            status.innerText = (friend && friend.typingTo === currentUser.id) ? "Typing..." : "";
        }

        // Start
        if(currentUser) {
            document.getElementById('authView').classList.add('hidden');
            document.getElementById('appView').classList.remove('hidden');
            document.getElementById('displayMyName').innerText = currentUser.name;
            document.getElementById('displayMyId').innerText = currentUser.id;
            setInterval(syncData, 2000);
            syncData();
        }
    </script>
</body>
</html>
