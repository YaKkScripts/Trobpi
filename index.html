<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balling.com | Real-Time Connect</title>
    <style>
        :root {
            --primary: #00bcd4;
            --primary-dark: #0097a7;
            --bg: #f0f4f8;
            --white: #ffffff;
            --text: #333;
            --error: #ff5252;
            --success: #4caf50;
            --gray: #999;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        
        /* UI Components */
        .container { max-width: 1200px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; padding: 10px; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.3); }
        
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; margin-bottom: 10px; }
        .mailbox-btn { position: relative; cursor: pointer; font-size: 1.5rem; transition: transform 0.2s; }
        .mailbox-btn:hover { transform: scale(1.1); }
        
        .app-grid { display: grid; grid-template-columns: 320px 1fr; gap: 15px; flex: 1; height: 82vh; }
        
        /* Sidebar */
        .sidebar { display: flex; flex-direction: column; padding: 15px; overflow: hidden; }
        .contact-list { overflow-y: auto; flex: 1; margin-top: 10px; }
        .user-card { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; }
        
        .nav-item { padding: 12px; margin-bottom: 8px; border-radius: 12px; cursor: pointer; transition: 0.2s; background: white; border: 1px solid #eee; position: relative; }
        .nav-item:hover { background: #f0fbff; }
        .nav-item.active { background: var(--primary); color: white; border-color: var(--primary); }
        .status-dot { width: 10px; height: 10px; background: #ccc; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-dot.online { background: var(--success); box-shadow: 0 0 5px var(--success); }

        /* Chat */
        .main-view { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .chat-box { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #fafafa; }
        .bubble { max-width: 75%; padding: 12px 16px; border-radius: 18px; font-size: 0.95rem; line-height: 1.4; position: relative; }
        .bubble.me { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .bubble.them { align-self: flex-start; background: #eee; color: #222; border-bottom-left-radius: 2px; }

        /* Inputs */
        .input-area { padding: 15px; display: flex; gap: 10px; background: white; border-top: 1px solid #eee; }
        input { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #ddd; outline: none; transition: 0.2s; }
        input:focus { border-color: var(--primary); }
        .btn { padding: 10px 20px; border-radius: 25px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-main { background: var(--primary); color: white; }
        .btn-main:hover { background: var(--primary-dark); }
        
        /* Overlays */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .call-overlay { position: fixed; inset: 0; background: #111; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        video { width: 90%; max-width: 500px; border-radius: 20px; background: #222; transform: scaleX(-1); }
    </style>
</head>
<body>

    <div class="container">
        <header id="appHeader" class="glass app-header hidden">
            <div>
                <h2 style="color: var(--primary); display: inline;">Balling</h2>
                <span id="globalStatus" style="font-size: 0.7rem; margin-left: 10px; color: var(--success);">‚óè LIVE</span>
            </div>
            <div class="mailbox-btn" onclick="toggleMailbox()">
                üì¨ <span id="mailBadge" class="hidden" style="position:absolute; top:-5px; right:-5px; background:red; color:white; border-radius:50%; padding:2px 6px; font-size:10px;">0</span>
            </div>
        </header>

        <div id="authView" class="fade-in">
            <div class="glass" style="max-width: 400px; margin: 80px auto; padding: 40px; text-align: center;">
                <h1 style="color: var(--primary); margin-bottom: 10px;">Balling.com</h1>
                <p id="authSubtitle" style="margin-bottom: 20px; color: #666;">Sign up to start balling.</p>
                
                <input type="text" id="usernameField" placeholder="Username" style="width: 100%; margin-bottom: 10px;">
                <input type="password" id="passwordField" placeholder="Password" style="width: 100%; margin-bottom: 10px;">
                
                <div id="idDisplay" class="hidden" style="background: #e0f7fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <small>Save your ID to login later:</small><br>
                    <strong id="generatedId" style="font-size: 1.2rem; color: var(--primary-dark);"></strong>
                </div>

                <button class="btn btn-main" id="primaryAuthBtn" style="width: 100%;" onclick="processSignup()">Create Account</button>
                <p style="margin-top: 15px; font-size: 0.9rem;">
                    <a href="#" id="authToggleLink" onclick="toggleAuthMode()">Already have an account? Login</a>
                </p>
            </div>
        </div>

        <div id="appView" class="hidden app-grid">
            <aside class="sidebar glass">
                <div class="user-card">
                    <h3 id="myName">User</h3>
                    <small id="myId">ID</small>
                    <div style="margin-top:10px; display:flex; gap:5px;">
                        <button class="btn" style="background:rgba(255,255,255,0.2); flex:1; font-size:0.7rem; color:white;" onclick="signOut()">Logout</button>
                    </div>
                </div>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <button class="btn btn-main" style="flex:1;" onclick="setNav('contacts')">Chats</button>
                    <button class="btn btn-ghost" style="flex:1;" onclick="setNav('add')">Add</button>
                </div>
                <div class="contact-list" id="contactContainer"></div>
            </aside>

            <main class="main-view glass">
                <div id="chatPlaceholder" style="text-align: center; margin-top: 25%; color: var(--gray);">
                    <h2>Welcome Back</h2>
                    <p>Select a contact or add a new ID to start.</p>
                </div>

                <div id="chatView" class="hidden" style="height:100%; display:flex; flex-direction:column;">
                    <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; background:white;">
                        <div>
                            <h3 id="chatName" onclick="renameContact()" style="cursor:pointer;">Friend</h3>
                            <small id="chatStatusText" style="color:var(--success)">Online</small>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-main" onclick="startCall()">üìû Call</button>
                            <button class="btn btn-ghost" id="blockBtn" onclick="toggleBlock()">Block</button>
                        </div>
                    </div>
                    <div class="chat-box" id="messageList"></div>
                    <div id="blockedMessage" class="hidden" style="padding:15px; text-align:center; background:#ffebee; color:red;">
                        You have blocked this user.
                    </div>
                    <div class="input-area" id="inputBar">
                        <input type="text" id="chatInput" placeholder="Message..." onkeypress="if(event.key==='Enter')sendMsg()">
                        <button class="btn btn-main" onclick="sendMsg()">Send</button>
                    </div>
                </div>

                <div id="addView" class="hidden" style="padding:40px;">
                    <h2>Add by Balling ID</h2>
                    <p>Enter the (XXX) XXX-XXX format ID.</p>
                    <input type="text" id="searchId" placeholder="(000) 000-000" style="width: 100%; margin-top:20px; font-size:1.5rem;">
                    <button class="btn btn-main" style="width:100%; margin-top:20px;" onclick="addContact()">Add Friend</button>
                </div>
            </main>
        </div>
    </div>

    <div id="callOverlay" class="hidden call-overlay">
        <h2 id="callStatus">In Call...</h2>
        <video id="localVideo" autoplay playsinline></video>
        <div style="margin-top:20px; display:flex; gap:20px;">
            <button class="btn" style="background:var(--error); color:white; padding:15px 40px;" onclick="endCall()">Hang Up</button>
        </div>
    </div>

    <script>
        // --- DATA & SYNC ---
        // In a real app, this would be a URL to a database API
        let db = JSON.parse(localStorage.getItem('balling_cloud_db')) || { users: {}, chats: {}, presence: {} };
        let currentUser = JSON.parse(localStorage.getItem('balling_session')) || null;
        let activeId = null;
        let stream = null;
        let isLoginMode = false;

        function cloudSync() {
            localStorage.setItem('balling_cloud_db', JSON.stringify(db));
            // Trigger storage event for other tabs/devices
            window.dispatchEvent(new Event('storage'));
        }

        // --- AUTH LOGIC ---
        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            document.getElementById('authSubtitle').innerText = isLoginMode ? "Login to your account." : "Sign up to start balling.";
            document.getElementById('primaryAuthBtn').innerText = isLoginMode ? "Login" : "Create Account";
            document.getElementById('authToggleLink').innerText = isLoginMode ? "Need an account? Sign Up" : "Already have an account? Login";
            document.getElementById('idDisplay').classList.add('hidden');
        }

        function processSignup() {
            if(isLoginMode) return processLogin();
            const user = document.getElementById('usernameField').value.trim();
            const pass = document.getElementById('passwordField').value.trim();
            if(!user || !pass) return alert("Fill all fields");

            const id = `(${Math.floor(Math.random()*900)+100}) ${Math.floor(Math.random()*900)+100}-${Math.floor(Math.random()*900)+100}`;
            db.users[id] = { user, pass, friends: {}, blocked: [], lastSeen: Date.now() };
            
            document.getElementById('generatedId').innerText = id;
            document.getElementById('idDisplay').classList.remove('hidden');
            document.getElementById('primaryAuthBtn').innerText = "Enter App";
            document.getElementById('primaryAuthBtn').onclick = () => doLogin(id);
            cloudSync();
        }

        function processLogin() {
            const user = document.getElementById('usernameField').value.trim();
            const pass = document.getElementById('passwordField').value.trim();
            const id = Object.keys(db.users).find(k => db.users[k].user === user && db.users[k].pass === pass);
            if(id) doLogin(id); else alert("Invalid Username or Password");
        }

        function doLogin(id) {
            currentUser = { id, name: db.users[id].user };
            localStorage.setItem('balling_session', JSON.stringify(currentUser));
            requestNotificationPermission();
            location.reload();
        }

        function signOut() {
            localStorage.removeItem('balling_session');
            location.reload();
        }

        // --- CHAT & MESSAGING ---
        function sendMsg() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if(!text || !activeId) return;

            const chan = [currentUser.id, activeId].sort().join('_');
            if(!db.chats[chan]) db.chats[chan] = [];
            
            db.chats[chan].push({
                sender: currentUser.id,
                senderName: currentUser.name,
                text: text,
                time: Date.now()
            });

            cloudSync();
            input.value = "";
            renderMessages();
        }

        function renderMessages() {
            const box = document.getElementById('messageList');
            const chan = [currentUser.id, activeId].sort().join('_');
            box.innerHTML = "";
            
            if(db.chats[chan]) {
                db.chats[chan].forEach(m => {
                    const b = document.createElement('div');
                    b.className = `bubble ${m.sender === currentUser.id ? 'me' : 'them'}`;
                    b.innerText = m.text;
                    box.appendChild(b);
                });
            }
            box.scrollTop = box.scrollHeight;
        }

        // --- NOTIFICATIONS ---
        function requestNotificationPermission() {
            if ("Notification" in window) {
                Notification.requestPermission();
            }
        }

        function notify(sender, text) {
            if (Notification.permission === "granted") {
                new Notification(`Balling: ${sender}`, { body: text });
            }
        }

        // --- CALLS ---
        async function startCall() {
            if(db.users[activeId].blocked.includes(currentUser.id)) return alert("User is unavailable.");
            db.presence[activeId] = { type: 'call', from: currentUser.id, name: currentUser.name };
            cloudSync();
            
            document.getElementById('callOverlay').classList.remove('hidden');
            stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('localVideo').srcObject = stream;
        }

        function endCall() {
            if(stream) stream.getTracks().forEach(t => t.stop());
            document.getElementById('callOverlay').classList.add('hidden');
            delete db.presence[currentUser.id];
            cloudSync();
        }

        // --- CONTACTS & UTILS ---
        function addContact() {
            const id = document.getElementById('searchId').value.trim();
            if(!db.users[id] || id === currentUser.id) return alert("Balling ID not found.");
            db.users[currentUser.id].friends[id] = db.users[id].user;
            cloudSync();
            setNav('contacts');
            openChat(id);
        }

        function openChat(id) {
            activeId = id;
            document.getElementById('chatPlaceholder').classList.add('hidden');
            document.getElementById('addView').classList.add('hidden');
            document.getElementById('chatView').classList.remove('hidden');
            
            const isBlocked = db.users[currentUser.id].blocked.includes(id);
            document.getElementById('inputBar').classList.toggle('hidden', isBlocked);
            document.getElementById('blockedMessage').classList.toggle('hidden', !isBlocked);
            document.getElementById('blockBtn').innerText = isBlocked ? "Unblock" : "Block";
            
            document.getElementById('chatName').innerText = db.users[currentUser.id].friends[id] || "Unknown";
            renderMessages();
            renderContacts();
        }

        function toggleBlock() {
            const list = db.users[currentUser.id].blocked;
            if(list.includes(activeId)) {
                db.users[currentUser.id].blocked = list.filter(i => i !== activeId);
            } else {
                list.push(activeId);
            }
            cloudSync();
            openChat(activeId);
        }

        function renderContacts() {
            const container = document.getElementById('contactContainer');
            container.innerHTML = "";
            const friends = db.users[currentUser.id].friends;
            
            Object.keys(friends).forEach(fId => {
                const isOnline = (Date.now() - db.users[fId].lastSeen) < 10000;
                const div = document.createElement('div');
                div.className = `nav-item ${activeId === fId ? 'active' : ''}`;
                div.innerHTML = `
                    <span class="status-dot ${isOnline ? 'online' : ''}"></span>
                    <strong>${friends[fId]}</strong><br>
                    <small style="opacity:0.6">${fId}</small>
                `;
                div.onclick = () => openChat(fId);
                container.appendChild(div);
            });
        }

        function setNav(v) {
            document.getElementById('chatPlaceholder').classList.toggle('hidden', v !== 'contacts');
            document.getElementById('addView').classList.toggle('hidden', v !== 'add');
            document.getElementById('chatView').classList.add('hidden');
        }

        // --- BACKGROUND LOOP (Real-time Simulation) ---
        setInterval(() => {
            if(!currentUser) return;
            
            // Update my online status
            db.users[currentUser.id].lastSeen = Date.now();
            
            // Check for new messages (for notifications)
            Object.keys(db.chats).forEach(chan => {
                if(chan.includes(currentUser.id)) {
                    const messages = db.chats[chan];
                    const lastMsg = messages[messages.length - 1];
                    if(lastMsg && lastMsg.sender !== currentUser.id && lastMsg.time > (Date.now() - 3000)) {
                        if(activeId !== lastMsg.sender) {
                            notify(lastMsg.senderName, lastMsg.text);
                        }
                    }
                }
            });

            // Check for incoming calls
            const call = db.presence[currentUser.id];
            if(call && call.type === 'call') {
                if(confirm(`${call.name} is calling! Accept?`)) {
                    activeId = call.from;
                    startCall();
                }
                delete db.presence[currentUser.id];
            }

            renderContacts();
            if(activeId) renderMessages();
            cloudSync();
        }, 3000);

        // Handle multi-tab sync
        window.addEventListener('storage', () => {
            db = JSON.parse(localStorage.getItem('balling_cloud_db'));
            renderContacts();
            if(activeId) renderMessages();
        });

        // Initialize
        if(currentUser) {
            document.getElementById('authView').classList.add('hidden');
            document.getElementById('appView').classList.remove('hidden');
            document.getElementById('appHeader').classList.remove('hidden');
            document.getElementById('myName').innerText = currentUser.name;
            document.getElementById('myId').innerText = currentUser.id;
            renderContacts();
        }
    </script>
</body>
</html>
