<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YakkScripts Connect</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #00d2ff; --bg: #0f172a; --card: #1e293b;
            --text: #f8fafc; --border: #334155; --accent: #38bdf8;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; }
        .hidden { display: none !important; }

        /* Layout */
        .app-shell { display: flex; width: 100vw; height: 100vh; padding: 12px; gap: 12px; }
        .panel { background: var(--card); border-radius: 20px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 320px; flex-shrink: 0; }
        .profile-trigger { 
            padding: 20px; 
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border-bottom: 1px solid var(--border); 
            cursor: pointer; 
            transition: 0.2s;
        }
        .profile-trigger:hover { background: #334155; }
        .avatar-frame { width: 55px; height: 55px; border-radius: 18px; object-fit: cover; background: #000; border: 2px solid var(--primary); }
        
        .nav-btn-row { padding: 12px; display: flex; gap: 8px; border-bottom: 1px solid var(--border); }
        .btn { flex: 1; padding: 12px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; font-size: 13px; transition: 0.2s; }
        .btn-main { background: var(--primary); color: #000; }
        .btn-sub { background: var(--border); color: white; }

        .list-box { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-item { display: flex; align-items: center; gap: 12px; padding: 15px; border-radius: 15px; cursor: pointer; margin-bottom: 6px; border: 1px solid transparent; }
        .chat-item:hover { background: rgba(255,255,255,0.05); }
        .chat-item.active { background: rgba(0, 210, 255, 0.1); border-color: var(--primary); }

        /* Chat area */
        .main-chat { flex: 1; }
        .chat-head { padding: 20px 25px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.2); }
        .msg-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .msg-b { max-width: 80%; padding: 12px 16px; border-radius: 18px; font-size: 14px; line-height: 1.5; }
        .msg-b.me { align-self: flex-end; background: var(--primary); color: #000; border-bottom-right-radius: 4px; }
        .msg-b.them { align-self: flex-start; background: var(--border); color: white; border-bottom-left-radius: 4px; }

        /* Modals */
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-ui { background: var(--card); width: 90%; max-width: 400px; padding: 35px; border-radius: 30px; border: 1px solid var(--border); text-align: center; }
        input { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid var(--border); border-radius: 12px; background: #0f172a; color: white; outline: none; }
        
        #loadScreen { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="loadScreen">
    <h2 style="letter-spacing: 8px; color: var(--primary);">SYSTEM LOADING</h2>
</div>

<div class="app-shell">
    <aside class="panel sidebar">
        <div class="profile-trigger" onclick="openMySettings()">
            <div style="display:flex; align-items:center; gap:15px;">
                <img id="sidePfp" src="https://api.dicebear.com/7.x/bottts/svg?seed=base" class="avatar-frame">
                <div style="flex:1">
                    <h3 id="sideName" style="color:white; font-size: 18px;">---</h3>
                    <p id="sideId" style="color:var(--primary); font-weight: 800; font-size: 13px;">ID: Loading...</p>
                </div>
            </div>
        </div>

        <div class="nav-btn-row">
            <button class="btn btn-main" onclick="addFriend()">+ FRIEND</button>
            <button class="btn btn-sub" onclick="createGroup()">+ GROUP</button>
        </div>

        <div class="list-box" id="sidebarList"></div>
    </aside>

    <main class="panel main-chat">
        <div id="noActiveChat" style="margin:auto; text-align:center; opacity:0.4;">
            <h1 style="font-size: 60px;">âš¡</h1>
            <h3>Select a connection</h3>
        </div>
        <div id="chatBody" class="hidden" style="display:flex; flex-direction:column; height:100%;">
            <div class="chat-head">
                <div id="chatAvatar" style="width:40px;height:40px;border-radius:10px;background:var(--primary);"></div>
                <h3 id="chatTitle">Name</h3>
            </div>
            <div class="msg-container" id="msgBox"></div>
            <div style="padding:20px; border-top:1px solid var(--border); display:flex; gap:10px; background: rgba(0,0,0,0.1);">
                <input type="text" id="msgInput" placeholder="Message..." style="margin:0;">
                <button class="btn btn-main" onclick="pushMsg()" style="flex:none; width:100px;">SEND</button>
            </div>
        </div>
    </main>
</div>

<div id="loginModal" class="modal-bg hidden">
    <div class="modal-ui">
        <h1 style="color:var(--primary); margin-bottom:10px;">YakkConnect</h1>
        <p style="margin-bottom:20px; opacity:0.6;">Sign up or Sign in to start balling.</p>
        <input type="text" id="userIn" placeholder="Username">
        <input type="password" id="passIn" placeholder="Password">
        <button class="btn btn-main" style="width:100%; padding:18px; margin-top:10px;" onclick="doAuth()">CONNECT</button>
    </div>
</div>

<div id="settingsModal" class="modal-bg hidden">
    <div class="modal-ui">
        <h3>User Profile</h3>
        <img id="prefPfp" src="" class="avatar-frame" style="width:100px; height:100px; margin:20px auto; display:block;">
        <input type="text" id="prefName" placeholder="Display Name">
        <input type="text" id="prefUrl" placeholder="Avatar Image URL">
        <button class="btn btn-main" style="width:100%; margin-top:15px;" onclick="saveMySettings()">SAVE UPDATES</button>
        <button class="btn btn-sub" style="width:100%; margin-top:10px;" onclick="closeAll()">CANCEL</button>
        <p style="margin-top:20px; color:red; cursor:pointer;" onclick="logout()">LOGOUT</p>
    </div>
</div>

<script>
    const SB_URL = "https://ubpsifoqjfzgmvhvwspv.supabase.co";
    const SB_KEY = "sb_publishable_tW5cED71cJC5tZtXla5D-g_wv4NfVwo";
    const sb = supabase.createClient(SB_URL, SB_KEY);

    let db = { users: {}, chats: {} };
    let session = JSON.parse(localStorage.getItem('yakk_session'));
    let activeChatId = null;

    window.onload = async () => {
        await sync();
        document.getElementById('loadScreen').classList.add('hidden');
        if(!session) {
            document.getElementById('loginModal').classList.remove('hidden');
        } else {
            startLoop();
        }
    };

    async function sync() {
        const { data } = await sb.from('balling_data').select('content').eq('id', 'main_db').single();
        if(data) db = data.content;
    }

    async function save() {
        await sb.from('balling_data').update({ content: db }).eq('id', 'main_db');
    }

    async function doAuth() {
        const u = document.getElementById('userIn').value.trim();
        const p = document.getElementById('passIn').value.trim();
        if(!u || !p) return;

        let id = Object.keys(db.users).find(k => db.users[k].user.toLowerCase() === u.toLowerCase());
        
        if(!id) {
            id = "B-" + Math.floor(1000 + Math.random() * 8999);
            db.users[id] = { user: u, pass: p, pfp: `https://api.dicebear.com/7.x/pixel-art/svg?seed=${u}`, friends: [], groups: [] };
            await save();
        } else if(db.users[id].pass !== p) {
            return alert("Wrong password.");
        }

        session = { id, user: u };
        localStorage.setItem('yakk_session', JSON.stringify(session));
        location.reload();
    }

    function startLoop() {
        refreshUI();
        setInterval(async () => { await sync(); refreshUI(); }, 3000);
    }

    function refreshUI() {
        const me = db.users[session.id];
        if(!me) return logout();

        // FORCE NAME AND ID UPDATE
        document.getElementById('sideName').innerText = me.user;
        document.getElementById('sideId').innerText = "ID: " + session.id;
        document.getElementById('sidePfp').src = me.pfp;

        const list = document.getElementById('sidebarList');
        let html = "";

        // Groups
        (me.groups || []).forEach(g => {
            html += `<div class="chat-item ${activeChatId === g ? 'active' : ''}" onclick="openChat('${g}', '${g.split('_')[0]}')">
                <div style="width:40px;height:40px;border-radius:10px;background:#334155;display:flex;align-items:center;justify-content:center;">#</div>
                <b>${g.split('_')[0]}</b>
            </div>`;
        });

        // Friends
        (me.friends || []).forEach(fid => {
            const f = db.users[fid];
            if(f) {
                html += `<div class="chat-item ${activeChatId === fid ? 'active' : ''}" onclick="openChat('${fid}', '${f.user}')">
                    <img src="${f.pfp}" style="width:40px;height:40px;border-radius:10px;">
                    <b>${f.user}</b>
                </div>`;
            }
        });

        list.innerHTML = html;
        if(activeChatId) drawMsgs();
    }

    function openChat(id, name) {
        activeChatId = id;
        document.getElementById('noActiveChat').classList.add('hidden');
        document.getElementById('chatBody').classList.remove('hidden');
        document.getElementById('chatTitle').innerText = name;
        drawMsgs();
    }

    async function pushMsg() {
        const input = document.getElementById('msgInput');
        if(!input.value.trim()) return;
        if(!db.chats[activeChatId]) db.chats[activeChatId] = [];
        db.chats[activeChatId].push({ s: session.id, u: db.users[session.id].user, t: input.value, d: Date.now() });
        input.value = "";
        await save();
        drawMsgs();
    }

    function drawMsgs() {
        const box = document.getElementById('msgBox');
        const m = db.chats[activeChatId] || [];
        box.innerHTML = m.map(msg => `
            <div class="msg-b ${msg.s === session.id ? 'me' : 'them'}">
                <div style="font-size:10px; opacity:0.5; margin-bottom:2px;">${msg.u}</div>
                ${msg.t}
            </div>
        `).join('');
        box.scrollTop = box.scrollHeight;
    }

    function openMySettings() {
        const me = db.users[session.id];
        document.getElementById('prefName').value = me.user;
        document.getElementById('prefUrl').value = me.pfp;
        document.getElementById('prefPfp').src = me.pfp;
        document.getElementById('settingsModal').classList.remove('hidden');
    }

    async function saveMySettings() {
        db.users[session.id].user = document.getElementById('prefName').value;
        db.users[session.id].pfp = document.getElementById('prefUrl').value;
        await save();
        closeAll();
        refreshUI();
    }

    function addFriend() {
        const fid = prompt("Enter Player ID:");
        if(!fid || !db.users[fid] || fid === session.id) return alert("Player not found!");
        if(!db.users[session.id].friends.includes(fid)) {
            db.users[session.id].friends.push(fid);
            db.users[fid].friends.push(session.id);
            save();
        }
    }

    function createGroup() {
        const n = prompt("Group Name:");
        if(!n) return;
        const gid = n + "_GRP_" + Date.now();
        db.users[session.id].groups.push(gid);
        db.chats[gid] = [];
        save();
    }

    function closeAll() { document.querySelectorAll('.modal-bg').forEach(m => m.classList.add('hidden')); }
    function logout() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
