<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balling.com | Cloud Connect</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #00bcd4;
            --primary-dark: #0097a7;
            --bg: #f0f4f8;
            --white: #ffffff;
            --text: #333;
            --error: #ff5252;
            --success: #4caf50;
            --gray: #999;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        
        .container { max-width: 1200px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; padding: 10px; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.3); }
        
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; margin-bottom: 10px; }
        .app-grid { display: grid; grid-template-columns: 320px 1fr; gap: 15px; flex: 1; height: 82vh; }
        
        .sidebar { display: flex; flex-direction: column; padding: 15px; overflow: hidden; }
        .contact-list { overflow-y: auto; flex: 1; margin-top: 10px; }
        .user-card { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; }
        
        .nav-item { padding: 12px; margin-bottom: 8px; border-radius: 12px; cursor: pointer; transition: 0.2s; background: white; border: 1px solid #eee; position: relative; display: flex; justify-content: space-between; align-items: center; }
        .nav-item:hover { border-color: var(--primary); }
        .nav-item.active { background: var(--primary); color: white; border-color: var(--primary); }
        .nav-item.blocked { opacity: 0.5; background: #ffebee; }

        .chat-box { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #fafafa; }
        .bubble { max-width: 75%; padding: 12px 16px; border-radius: 18px; font-size: 0.95rem; word-wrap: break-word; }
        .bubble.me { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .bubble.them { align-self: flex-start; background: #eee; color: #222; border-bottom-left-radius: 2px; }

        .input-area { padding: 15px; display: flex; gap: 10px; background: white; border-top: 1px solid #eee; }
        input { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #ddd; outline: none; }
        .btn { padding: 10px 20px; border-radius: 25px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-main { background: var(--primary); color: white; }
        .btn:active { transform: scale(0.95); }
        
        .call-overlay { position: fixed; inset: 0; background: #111; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        video { width: 90%; max-width: 500px; border-radius: 20px; background: #222; }
        .block-btn { color: var(--error); font-size: 0.8rem; cursor: pointer; padding: 5px; }
    </style>
</head>
<body>

    <div class="container">
        <header id="appHeader" class="glass app-header hidden">
            <h2 style="color: var(--primary)">Balling Cloud</h2>
            <div id="cloudStatus" style="font-size: 0.7rem; color: var(--success);">‚òÅÔ∏è SYNCED</div>
        </header>

        <div id="authView">
            <div class="glass" style="max-width: 400px; margin: 80px auto; padding: 40px; text-align: center;">
                <h1 style="color: var(--primary); margin-bottom: 20px;">Balling.com</h1>
                <div id="authInputs">
                    <input type="text" id="usernameField" placeholder="Username" style="width: 100%; margin-bottom: 10px;">
                    <input type="password" id="passwordField" placeholder="Password" style="width: 100%; margin-bottom: 10px;">
                    
                    <div id="idDisplay" class="hidden" style="background: #e0f7fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <small>Your Universal Balling ID:</small><br>
                        <strong id="generatedId" style="color: var(--primary-dark);"></strong>
                    </div>

                    <button class="btn btn-main" id="primaryAuthBtn" style="width: 100%;" onclick="processAuth()">Create Account</button>
                    <p style="margin-top: 15px; font-size: 0.9rem;">
                        <a href="#" id="authToggleLink" onclick="toggleAuthMode()">Already have an account? Login</a>
                    </p>
                </div>
            </div>
        </div>

        <div id="appView" class="hidden app-grid">
            <aside class="sidebar glass">
                <div class="user-card">
                    <h3 id="myName">User</h3>
                    <small id="myId">ID</small>
                    <button class="btn" style="background:rgba(255,255,255,0.2); width:100%; margin-top:10px; color:white;" onclick="signOut()">Logout</button>
                </div>
                <div style="display:flex; gap:5px;">
                    <button class="btn btn-main" style="flex:1;" onclick="setNav('contacts')">Chats</button>
                    <button class="btn" style="flex:1; background:#eee;" onclick="setNav('add')">Add</button>
                </div>
                <div class="contact-list" id="contactContainer"></div>
            </aside>

            <main class="main-view glass">
                <div id="chatPlaceholder" style="text-align: center; margin-top: 25%; color: var(--gray);">
                    <h2>Select a conversation</h2>
                </div>

                <div id="chatView" class="hidden" style="height:100%; display:flex; flex-direction:column;">
                    <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h3 id="chatName" style="cursor:pointer;" onclick="renameFriend()">Friend</h3>
                            <small id="chatIdDisplay" style="color:var(--gray)"></small>
                        </div>
                        <button class="btn btn-main" onclick="startCall()">üìû Call</button>
                    </div>
                    <div class="chat-box" id="messageList"></div>
                    <div class="input-area">
                        <input type="text" id="chatInput" placeholder="Message..." onkeypress="if(event.key==='Enter')sendMsg()">
                        <button class="btn btn-main" onclick="sendMsg()">Send</button>
                    </div>
                </div>

                <div id="addView" class="hidden" style="padding:40px;">
                    <h2>Connect to Friend</h2>
                    <input type="text" id="searchId" placeholder="(000) 000-000" style="width: 100%; margin-top:20px;">
                    <button class="btn btn-main" style="width:100%; margin-top:20px;" onclick="addContact()">Add by ID</button>
                </div>
            </main>
        </div>
    </div>

    <div id="callOverlay" class="hidden call-overlay">
        <h2 id="callStatus">Calling...</h2>
        <video id="localVideo" autoplay playsinline muted></video>
        <button class="btn" style="background:red; color:white; margin-top:20px;" onclick="endCall()">Hang Up</button>
    </div>

    <script>
        const SB_URL = "https://ubpsifoqjfzgmvhvwspv.supabase.co";
        const SB_KEY = "sb_publishable_tW5cED71cJC5tZtXla5D-g_wv4NfVwo";
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        let db = { users: {}, chats: {}, presence: {} };
        let currentUser = JSON.parse(localStorage.getItem('balling_session'));
        let activeId = null;
        let isLoginMode = false;

        async function loadCloudDB() {
            const { data, error } = await _supabase.from('balling_data').select('content').eq('id', 'main_db').single();
            if (data && data.content) {
                db = data.content;
                if(currentUser) {
                    renderContacts();
                    if(activeId) renderMessages();
                    checkPresence();
                }
            }
        }

        async function saveCloudDB() {
            document.getElementById('cloudStatus').innerText = "‚è≥ SAVING...";
            await _supabase.from('balling_data').upsert({ id: 'main_db', content: db });
            document.getElementById('cloudStatus').innerText = "‚òÅÔ∏è SYNCED";
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            document.getElementById('primaryAuthBtn').innerText = isLoginMode ? "Login" : "Create Account";
            document.getElementById('primaryAuthBtn').onclick = processAuth;
            document.getElementById('authToggleLink').innerText = isLoginMode ? "Need an account? Sign Up" : "Already have an account? Login";
            document.getElementById('idDisplay').classList.add('hidden');
        }

        async function processAuth() {
            const user = document.getElementById('usernameField').value.trim();
            const pass = document.getElementById('passwordField').value.trim();
            if(!user || !pass) return alert("Missing fields");

            await loadCloudDB();

            if(isLoginMode) {
                const id = Object.keys(db.users).find(k => db.users[k].user.toLowerCase() === user.toLowerCase() && db.users[k].pass === pass);
                if(id) loginUser(id); else alert("Invalid credentials");
            } else {
                const id = `(${Math.floor(Math.random()*900)+100}) ${Math.floor(Math.random()*900)+100}-${Math.floor(Math.random()*900)+100}`;
                if(!db.users) db.users = {};
                db.users[id] = { user, pass, friends: {}, blocks: [], lastSeen: Date.now() };
                
                document.getElementById('generatedId').innerText = id;
                document.getElementById('idDisplay').classList.remove('hidden');
                document.getElementById('primaryAuthBtn').innerText = "Confirm & Enter";
                document.getElementById('primaryAuthBtn').onclick = () => loginUser(id);
                await saveCloudDB();
            }
        }

        function loginUser(id) {
            currentUser = { id, name: db.users[id].user };
            localStorage.setItem('balling_session', JSON.stringify(currentUser));
            location.reload(); 
        }

        function signOut() {
            localStorage.removeItem('balling_session');
            location.reload();
        }

        async function sendMsg() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if(!text || !activeId) return;

            // Check if blocked
            if(db.users[activeId].blocks && db.users[activeId].blocks.includes(currentUser.id)) {
                return alert("Message failed to send.");
            }

            const chan = [currentUser.id, activeId].sort().join('_');
            if(!db.chats) db.chats = {};
            if(!db.chats[chan]) db.chats[chan] = [];
            
            db.chats[chan].push({ sender: currentUser.id, text, time: Date.now() });
            input.value = "";
            renderMessages();
            await saveCloudDB();
        }

        function renderMessages() {
            const box = document.getElementById('messageList');
            const chan = [currentUser.id, activeId].sort().join('_');
            if(!db.chats || !db.chats[chan]) { box.innerHTML = ""; return; }

            let html = "";
            db.chats[chan].forEach(m => {
                html += `<div class="bubble ${m.sender === currentUser.id ? 'me' : 'them'}">${m.text}</div>`;
            });
            box.innerHTML = html;
            box.scrollTop = box.scrollHeight;
        }

        async function addContact() {
            const id = document.getElementById('searchId').value.trim();
            if(!db.users[id]) return alert("ID not found");
            if(id === currentUser.id) return alert("That's your own ID!");

            if(!db.users[currentUser.id].friends) db.users[currentUser.id].friends = {};
            db.users[currentUser.id].friends[id] = db.users[id].user;
            await saveCloudDB();
            setNav('contacts');
        }

        function toggleBlock(fId, event) {
            event.stopPropagation();
            if(!db.users[currentUser.id].blocks) db.users[currentUser.id].blocks = [];
            
            const index = db.users[currentUser.id].blocks.indexOf(fId);
            if(index > -1) {
                db.users[currentUser.id].blocks.splice(index, 1);
                alert("Unblocked");
            } else {
                db.users[currentUser.id].blocks.push(fId);
                alert("Blocked");
            }
            saveCloudDB();
            renderContacts();
        }

        async function renameFriend() {
            if(!activeId) return;
            const newName = prompt("Enter new nickname for this friend:");
            if(newName) {
                db.users[currentUser.id].friends[activeId] = newName;
                document.getElementById('chatName').innerText = newName;
                await saveCloudDB();
                renderContacts();
            }
        }

        function renderContacts() {
            const container = document.getElementById('contactContainer');
            const friends = db.users[currentUser.id]?.friends || {};
            const blocks = db.users[currentUser.id]?.blocks || [];
            let html = "";
            Object.keys(friends).forEach(fId => {
                const isBlocked = blocks.includes(fId);
                html += `<div class="nav-item ${activeId === fId ? 'active' : ''} ${isBlocked ? 'blocked' : ''}" onclick="openChat('${fId}')">
                    <div><strong>${friends[fId]}</strong><br><small>${fId}</small></div>
                    <span class="block-btn" onclick="toggleBlock('${fId}', event)">${isBlocked ? 'Unblock' : 'Block'}</span>
                </div>`;
            });
            container.innerHTML = html;
        }

        function openChat(id) {
            activeId = id;
            document.getElementById('chatPlaceholder').classList.add('hidden');
            document.getElementById('addView').classList.add('hidden');
            document.getElementById('chatView').classList.remove('hidden');
            document.getElementById('chatName').innerText = db.users[currentUser.id].friends[id];
            document.getElementById('chatIdDisplay').innerText = id;
            renderMessages();
        }

        function setNav(v) {
            document.getElementById('chatPlaceholder').classList.toggle('hidden', v !== 'contacts');
            document.getElementById('addView').classList.toggle('hidden', v !== 'add');
            document.getElementById('chatView').classList.add('hidden');
            activeId = null;
        }

        function checkPresence() {
            if(!db.presence) db.presence = {};
            const call = db.presence[currentUser.id];
            if(call && call.type === 'incoming') {
                if(confirm(`Incoming call from ${call.name}!`)) {
                    startCall(true);
                }
                delete db.presence[currentUser.id];
                saveCloudDB();
            }
        }

        async function startCall(isIncoming = false) {
            document.getElementById('callOverlay').classList.remove('hidden');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = stream;
            } catch(e) {
                document.getElementById('callStatus').innerText = "No Camera/Mic Found";
            }
            if(!isIncoming && activeId) {
                if(!db.presence) db.presence = {};
                db.presence[activeId] = { type: 'incoming', from: currentUser.id, name: currentUser.name };
                saveCloudDB();
            }
        }

        function endCall() {
            document.getElementById('callOverlay').classList.add('hidden');
            const video = document.getElementById('localVideo');
            if(video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
        }

        // STARTUP
        if(currentUser) {
            document.getElementById('authView').classList.add('hidden');
            document.getElementById('appView').classList.remove('hidden');
            document.getElementById('appHeader').classList.remove('hidden');
            document.getElementById('myName').innerText = currentUser.name;
            document.getElementById('myId').innerText = currentUser.id;
        }
        
        loadCloudDB();
        setInterval(loadCloudDB, 3500);
    </script>
</body>
</html>
